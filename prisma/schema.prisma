// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id // Uses Supabase Auth user ID
  email     String   @unique
  name      String?
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workspaces Workspace[]

  @@map("users")
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // DNS Status fields (Story 2.2)
  spfStatus    DnsStatus @default(NOT_STARTED) @map("spf_status")
  dkimStatus   DnsStatus @default(NOT_STARTED) @map("dkim_status")
  dmarcStatus  DnsStatus @default(NOT_STARTED) @map("dmarc_status")
  dkimSelector String?   @map("dkim_selector")

  // Onboarding status (Story 2.4)
  onboardingComplete Boolean @default(false) @map("onboarding_complete")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  prospects      Prospect[]
  gmailToken     GmailToken?
  icpConfig      IcpConfig?
  enrichmentJobs EnrichmentJob[]
  sequences      Sequence[]
  openerCaches   OpenerCache[]

  @@map("workspaces")
  @@index([userId])
}

model IcpConfig {
  id           String   @id @default(cuid())
  workspaceId  String   @unique @map("workspace_id")
  industries   String[] @default([])
  companySizes String[] @map("company_sizes") @default([])
  roles        String[] @default([])
  locations    String[] @default([])
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("icp_configs")
}

model Prospect {
  id               String          @id @default(cuid())
  workspaceId      String          @map("workspace_id")
  email            String
  firstName        String?         @map("first_name")
  lastName         String?         @map("last_name")
  company          String?
  title            String?
  phone            String?
  linkedinUrl      String?         @map("linkedin_url")
  source           ProspectSource  @default(OTHER)
  sourceDetail     String?         @map("source_detail")
  status           ProspectStatus  @default(NEW)
  enrichmentSource String?         @map("enrichment_source")
  enrichedAt       DateTime?       @map("enriched_at")
  enrichmentData   Json?           @map("enrichment_data")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  deletedAt        DateTime?       @map("deleted_at")
  deletedBy        String?         @map("deleted_by")

  workspace        Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enrichmentJobs   EnrichmentJob[]
  openerCaches     OpenerCache[]

  @@unique([workspaceId, email])
  @@index([workspaceId])
  @@index([deletedAt])
  @@map("prospects")
}

enum ProspectSource {
  CRM_EXPORT
  EVENT_CONFERENCE
  NETWORK_REFERRAL
  CONTENT_DOWNLOAD
  OUTBOUND_RESEARCH
  OTHER

  @@map("prospect_source")
}

enum ProspectStatus {
  NEW
  ENRICHING
  VERIFIED
  NOT_VERIFIED
  NEEDS_REVIEW
  SUPPRESSED
  CONTACTED
  REPLIED
  BOUNCED
  UNSUBSCRIBED
  BOOKED

  @@map("prospect_status")
}

enum DnsStatus {
  NOT_STARTED
  PASS
  FAIL
  UNKNOWN
  MANUAL_OVERRIDE

  @@map("dns_status")
}

model GmailToken {
  id           String   @id @default(cuid())
  workspaceId  String   @unique @map("workspace_id")
  accessToken  String   @map("access_token")   // AES-256-GCM encrypted
  refreshToken String   @map("refresh_token")  // AES-256-GCM encrypted
  expiresAt    DateTime @map("expires_at")
  email        String                          // Gmail email address
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("gmail_tokens")
}

model EnrichmentJob {
  id          String              @id @default(cuid())
  prospectId  String              @map("prospect_id")
  workspaceId String              @map("workspace_id")
  requestId   String?             @map("request_id")
  status      EnrichmentJobStatus @default(PENDING)
  attempts    Int                 @default(0)
  lastError   String?             @map("last_error")
  nextRetryAt DateTime?           @map("next_retry_at")
  createdAt   DateTime            @default(now()) @map("created_at")
  completedAt DateTime?           @map("completed_at")

  prospect  Prospect  @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("enrichment_jobs")
  @@index([workspaceId, status])
  @@index([nextRetryAt, status])
}

enum EnrichmentJobStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED

  @@map("enrichment_job_status")
}

model AuditLog {
  id          String   @id @default(cuid())
  workspaceId String   @map("workspace_id")
  userId      String   @map("user_id")
  action      String   // PROSPECT_DELETED, CAMPAIGN_LAUNCHED, etc.
  entityType  String   @map("entity_type") // PROSPECT, CAMPAIGN, etc.
  entityId    String   @map("entity_id")
  metadata    Json?    // Additional context (cascade summary, etc.)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
  @@index([workspaceId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

enum SequenceStatus {
  DRAFT
  READY
  ARCHIVED

  @@map("sequence_status")
}

model Sequence {
  id          String         @id @default(cuid())
  workspaceId String         @map("workspace_id")
  name        String
  status      SequenceStatus @default(DRAFT)
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  workspace    Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  steps        SequenceStep[]
  openerCaches OpenerCache[]

  @@map("sequences")
  @@index([workspaceId])
}

model SequenceStep {
  id         String   @id @default(cuid())
  sequenceId String   @map("sequence_id")
  order      Int      // 1, 2, 3
  subject    String
  body       String   @db.Text
  delayDays  Int      @default(0) @map("delay_days") // Days after previous step
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  sequence     Sequence      @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  openerCaches OpenerCache[]

  @@map("sequence_steps")
  @@index([sequenceId])
  @@unique([sequenceId, order])
}

model OpenerCache {
  id                String   @id @default(cuid())
  workspaceId       String   @map("workspace_id")
  prospectId        String   @map("prospect_id")
  sequenceId        String   @map("sequence_id")
  stepId            String   @map("step_id")
  openerText        String   @map("opener_text") @db.Text
  regenerationCount Int      @default(0) @map("regeneration_count")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  workspace Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  prospect  Prospect     @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  sequence  Sequence     @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  step      SequenceStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, prospectId, sequenceId, stepId])
  @@map("opener_cache")
  @@index([workspaceId])
  @@index([prospectId])
  @@index([sequenceId])
}
