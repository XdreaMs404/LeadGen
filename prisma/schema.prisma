// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id // Uses Supabase Auth user ID
  email     String   @unique
  name      String?
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workspaces    Workspace[]
  notifications Notification[]

  @@map("users")
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // DNS Status fields (Story 2.2)
  spfStatus    DnsStatus @default(NOT_STARTED) @map("spf_status")
  dkimStatus   DnsStatus @default(NOT_STARTED) @map("dkim_status")
  dmarcStatus  DnsStatus @default(NOT_STARTED) @map("dmarc_status")
  dkimSelector String?   @map("dkim_selector")

  // Onboarding status (Story 2.4)
  onboardingComplete Boolean @default(false) @map("onboarding_complete")

  // Story 6.1: Inbox sync tracking
  lastSyncedAt DateTime? @map("last_synced_at")

  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  prospects      Prospect[]
  gmailToken     GmailToken?
  icpConfig      IcpConfig?
  enrichmentJobs EnrichmentJob[]
  sequences      Sequence[]
  openerCaches   OpenerCache[]
  campaigns      Campaign[]
  sendingSettings SendingSettings?
  notifications  Notification[]
  conversations  Conversation[]

  @@map("workspaces")
  @@index([userId])
}

model SendingSettings {
  id            String   @id @default(cuid())
  workspaceId   String   @unique @map("workspace_id")
  sendingDays   Json     @default("[1,2,3,4,5]") @map("sending_days") // Array of 0-6 (Sun-Sat)
  startHour     Int      @default(9) @map("start_hour")  // 0-23
  endHour       Int      @default(18) @map("end_hour")   // 0-23
  timezone      String   @default("Europe/Paris")
  dailyQuota    Int      @default(30) @map("daily_quota") // 20-50
  rampUpEnabled Boolean  @default(true) @map("ramp_up_enabled")
  fromName      String?  @map("from_name")
  signature     String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("sending_settings")
}

model IcpConfig {
  id           String   @id @default(cuid())
  workspaceId  String   @unique @map("workspace_id")
  industries   String[] @default([])
  companySizes String[] @map("company_sizes") @default([])
  roles        String[] @default([])
  locations    String[] @default([])
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("icp_configs")
}

model Prospect {
  id               String          @id @default(cuid())
  workspaceId      String          @map("workspace_id")
  email            String
  firstName        String?         @map("first_name")
  lastName         String?         @map("last_name")
  company          String?
  title            String?
  phone            String?
  linkedinUrl      String?         @map("linkedin_url")
  source           ProspectSource  @default(OTHER)
  sourceDetail     String?         @map("source_detail")
  status           ProspectStatus  @default(NEW)
  enrichmentSource String?         @map("enrichment_source")
  enrichedAt       DateTime?       @map("enriched_at")
  enrichmentData   Json?           @map("enrichment_data")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  deletedAt        DateTime?       @map("deleted_at")
  deletedBy        String?         @map("deleted_by")

  workspace            Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  enrichmentJobs       EnrichmentJob[]
  openerCaches         OpenerCache[]
  campaignEnrollments  CampaignProspect[]
  scheduledEmails      ScheduledEmail[]
  sentEmails           SentEmail[]
  conversations        Conversation[]

  @@unique([workspaceId, email])
  @@index([workspaceId])
  @@index([deletedAt])
  @@map("prospects")
}

enum ProspectSource {
  CRM_EXPORT
  EVENT_CONFERENCE
  NETWORK_REFERRAL
  CONTENT_DOWNLOAD
  OUTBOUND_RESEARCH
  OTHER

  @@map("prospect_source")
}

enum ProspectStatus {
  NEW
  ENRICHING
  VERIFIED
  NOT_VERIFIED
  NEEDS_REVIEW
  SUPPRESSED
  CONTACTED
  REPLIED
  BOUNCED
  UNSUBSCRIBED
  BOOKED

  @@map("prospect_status")
}

enum DnsStatus {
  NOT_STARTED
  PASS
  FAIL
  UNKNOWN
  MANUAL_OVERRIDE

  @@map("dns_status")
}

model GmailToken {
  id           String   @id @default(cuid())
  workspaceId  String   @unique @map("workspace_id")
  accessToken  String   @map("access_token")   // AES-256-GCM encrypted
  refreshToken String   @map("refresh_token")  // AES-256-GCM encrypted
  expiresAt    DateTime @map("expires_at")
  email        String                          // Gmail email address
  isValid      Boolean  @default(true) @map("is_valid") // Story 6.1: Track valid/invalid status
  lastAuthError String? @map("last_auth_error")         // Story 6.1: Reason for invalidation
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("gmail_tokens")
}

model EnrichmentJob {
  id          String              @id @default(cuid())
  prospectId  String              @map("prospect_id")
  workspaceId String              @map("workspace_id")
  requestId   String?             @map("request_id")
  status      EnrichmentJobStatus @default(PENDING)
  attempts    Int                 @default(0)
  lastError   String?             @map("last_error")
  nextRetryAt DateTime?           @map("next_retry_at")
  createdAt   DateTime            @default(now()) @map("created_at")
  completedAt DateTime?           @map("completed_at")

  prospect  Prospect  @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("enrichment_jobs")
  @@index([workspaceId, status])
  @@index([nextRetryAt, status])
}

enum EnrichmentJobStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED

  @@map("enrichment_job_status")
}

model AuditLog {
  id          String   @id @default(cuid())
  workspaceId String   @map("workspace_id")
  userId      String   @map("user_id")
  action      String   // PROSPECT_DELETED, CAMPAIGN_LAUNCHED, etc.
  entityType  String   @map("entity_type") // PROSPECT, CAMPAIGN, etc.
  entityId    String   @map("entity_id")
  metadata    Json?    // Additional context (cascade summary, etc.)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
  @@index([workspaceId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

enum SequenceStatus {
  DRAFT
  READY
  ARCHIVED

  @@map("sequence_status")
}

enum CampaignStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  STOPPED

  @@map("campaign_status")
}

enum EnrollmentStatus {
  ENROLLED
  PAUSED
  COMPLETED
  STOPPED
  REPLIED

  @@map("enrollment_status")
}

// Story 5.8: Auto-pause reasons for anomaly detection
enum AutoPauseReason {
  HIGH_BOUNCE_RATE
  HIGH_UNSUBSCRIBE_RATE
  HIGH_COMPLAINT_RATE

  @@map("auto_pause_reason")
}

// Story 6.1: Inbox models for reply sync
enum ConversationStatus {
  OPEN
  CLOSED
  ARCHIVED

  @@map("conversation_status")
}

enum MessageDirection {
  INBOUND
  OUTBOUND

  @@map("message_direction")
}

enum ReplyClassification {
  INTERESTED
  NOT_INTERESTED
  NOT_NOW
  NEGATIVE
  OUT_OF_OFFICE
  UNSUBSCRIBE
  BOUNCE
  NEEDS_REVIEW
  OTHER

  @@map("reply_classification")
}

// Story 6.4: Classification method tracking
enum ClassificationMethod {
  RULE
  LLM
  MANUAL

  @@map("classification_method")
}

model Sequence {
  id               String         @id @default(cuid())
  workspaceId      String         @map("workspace_id")
  name             String
  description      String?        // Optional description for templates
  isTemplate       Boolean        @default(false) @map("is_template")
  sourceTemplateId String?        @map("source_template_id") // Track origin template
  status           SequenceStatus @default(DRAFT)
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  workspace       Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  steps           SequenceStep[]
  openerCaches    OpenerCache[]
  campaigns       Campaign[]
  scheduledEmails ScheduledEmail[]

  @@map("sequences")
  @@index([workspaceId])
  @@index([isTemplate])
}

model SequenceStep {
  id         String   @id @default(cuid())
  sequenceId String   @map("sequence_id")
  order      Int      // 1, 2, 3
  subject    String
  body       String   @db.Text
  delayDays  Int      @default(0) @map("delay_days") // Days after previous step
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  sequence     Sequence      @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  openerCaches OpenerCache[]

  @@map("sequence_steps")
  @@index([sequenceId])
  @@unique([sequenceId, order])
}

model OpenerCache {
  id                String   @id @default(cuid())
  workspaceId       String   @map("workspace_id")
  prospectId        String   @map("prospect_id")
  sequenceId        String   @map("sequence_id")
  stepId            String   @map("step_id")
  openerText        String   @map("opener_text") @db.Text
  regenerationCount Int      @default(0) @map("regeneration_count")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  workspace Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  prospect  Prospect     @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  sequence  Sequence     @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  step      SequenceStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, prospectId, sequenceId, stepId])
  @@map("opener_cache")
  @@index([workspaceId])
  @@index([prospectId])
  @@index([sequenceId])
}

model Campaign {
  id          String         @id @default(cuid())
  workspaceId String         @map("workspace_id")
  name        String
  sequenceId  String?        @map("sequence_id")
  status      CampaignStatus @default(DRAFT)
  createdAt   DateTime       @default(now()) @map("created_at")
  startedAt   DateTime?      @map("started_at")
  pausedAt    DateTime?      @map("paused_at")
  completedAt DateTime?      @map("completed_at")
  stoppedAt   DateTime?      @map("stopped_at")
  autoPausedReason AutoPauseReason? @map("auto_paused_reason") // Story 5.8

  workspace       Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  sequence        Sequence?          @relation(fields: [sequenceId], references: [id])
  prospects       CampaignProspect[]
  scheduledEmails ScheduledEmail[]
  sentEmails      SentEmail[]
  conversations   Conversation[]

  @@map("campaigns")
  @@index([workspaceId])
  @@index([status])
}


model CampaignProspect {
  id               String           @id @default(cuid())
  campaignId       String           @map("campaign_id")
  prospectId       String           @map("prospect_id")
  enrollmentStatus EnrollmentStatus @default(ENROLLED) @map("enrollment_status")
  currentStep      Int              @default(1) @map("current_step")
  enrolledAt       DateTime         @default(now()) @map("enrolled_at")
  pausedAt         DateTime?        @map("paused_at")
  completedAt      DateTime?        @map("completed_at")

  campaign        Campaign         @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  prospect        Prospect         @relation(fields: [prospectId], references: [id])
  scheduledEmails ScheduledEmail[]

  @@unique([campaignId, prospectId])
  @@map("campaign_prospects")
  @@index([campaignId])
  @@index([prospectId])
}

// Story 5.4: Email Scheduling Queue with Idempotency
enum ScheduledEmailStatus {
  SCHEDULED          // Initial state, waiting to be picked up
  SENDING            // Currently being sent (locked)
  SENT               // Successfully sent
  FAILED             // Failed, will retry
  RETRY_SCHEDULED    // Waiting for retry
  PERMANENTLY_FAILED // Max retries exceeded or non-retryable error
  CANCELLED          // Campaign stopped or prospect paused

  @@map("scheduled_email_status")
}

model ScheduledEmail {
  id                 String               @id @default(cuid())
  workspaceId        String               @map("workspace_id")
  campaignId         String               @map("campaign_id")
  campaignProspectId String               @map("campaign_prospect_id")
  prospectId         String               @map("prospect_id")
  sequenceId         String               @map("sequence_id")
  stepNumber         Int                  @map("step_number")
  idempotencyKey     String               @unique @map("idempotency_key")
  status             ScheduledEmailStatus @default(SCHEDULED)
  scheduledFor       DateTime             @map("scheduled_for")
  attempts           Int                  @default(0)
  lastError          String?              @map("last_error") @db.Text
  nextRetryAt        DateTime?            @map("next_retry_at")
  messageId          String?              @map("message_id")    // Gmail message ID (Story 5.5)
  threadId           String?              @map("thread_id")     // Gmail thread ID (Story 5.5)
  sentAt             DateTime?            @map("sent_at")
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")

  campaign         Campaign         @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignProspect CampaignProspect @relation(fields: [campaignProspectId], references: [id], onDelete: Cascade)
  prospect         Prospect         @relation(fields: [prospectId], references: [id])
  sequence         Sequence         @relation(fields: [sequenceId], references: [id])

  @@map("scheduled_emails")
  @@index([workspaceId])
  @@index([status])
  @@index([scheduledFor])
  @@index([nextRetryAt, status])
  @@index([campaignId])

  sentEmail SentEmail?
}

// Story 5.5: Gmail API Email Sending with Threading
model SentEmail {
  id               String   @id @default(cuid())
  workspaceId      String   @map("workspace_id")
  scheduledEmailId String   @unique @map("scheduled_email_id")
  campaignId       String   @map("campaign_id")
  prospectId       String   @map("prospect_id")
  messageId        String   @map("message_id")     // Gmail message ID
  threadId         String   @map("thread_id")      // Gmail thread ID
  subject          String
  toAddress        String   @map("to_address")
  headers          Json?                           // Full headers JSON
  sentAt           DateTime @map("sent_at")
  createdAt        DateTime @default(now()) @map("created_at")

  scheduledEmail ScheduledEmail @relation(fields: [scheduledEmailId], references: [id], onDelete: Cascade)
  campaign       Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  prospect       Prospect       @relation(fields: [prospectId], references: [id])

  @@map("sent_emails")
  @@index([workspaceId])
  @@index([campaignId])
  @@index([prospectId])
  @@index([threadId])
}

model Notification {
  id          String   @id @default(cuid())
  workspaceId String   @map("workspace_id")
  userId      String?  @map("user_id")
  type        String   // ANOMALY_WARNING, ANOMALY_PAUSE
  severity    String   // WARNING, ERROR, INFO
  title       String
  message     String
  metadata    Json?
  isRead      Boolean  @default(false) @map("is_read")
  createdAt   DateTime @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
  @@index([workspaceId])
  @@index([userId])
  @@index([isRead])
}

// Story 6.1: Conversation model for inbox reply tracking
model Conversation {
  id            String             @id @default(cuid())
  threadId      String             @map("thread_id")
  workspaceId   String             @map("workspace_id")
  prospectId    String?            @map("prospect_id")
  campaignId    String?            @map("campaign_id")
  sequenceId    String?            @map("sequence_id")
  status        ConversationStatus @default(OPEN)
  lastMessageAt DateTime           @map("last_message_at")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")

  workspace Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  prospect  Prospect?     @relation(fields: [prospectId], references: [id])
  campaign  Campaign?     @relation(fields: [campaignId], references: [id])
  messages  InboxMessage[]

  @@unique([workspaceId, threadId])
  @@index([workspaceId])
  @@index([prospectId])
  @@map("conversations")
}

// Story 6.1: InboxMessage model for storing email messages
model InboxMessage {
  id              String               @id @default(cuid())
  conversationId  String               @map("conversation_id")
  gmailMessageId  String               @map("gmail_message_id")
  direction       MessageDirection
  subject         String?
  bodyRaw         String               @map("body_raw") @db.Text
  bodyCleaned     String?              @map("body_cleaned") @db.Text
  fromEmail       String               @map("from_email")
  toEmail         String               @map("to_email")
  receivedAt      DateTime             @map("received_at")
  classification        ReplyClassification?
  confidenceScore       Int?                   @map("confidence_score")
  classificationMethod  ClassificationMethod?  @map("classification_method")
  needsReview           Boolean                @default(false) @map("needs_review")
  isRead                Boolean                @default(false) @map("is_read")
  createdAt             DateTime               @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, gmailMessageId])
  @@index([conversationId])
  @@map("inbox_messages")
}
